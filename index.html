<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>میو GPT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
    />
    <style>
      :root {
        --primary: #8b5cf6;
        --bg: #0f172a;
        --surface: #1e293b;
        --text: #e2e8f0;
        --accent: #9333ea;
      }

      * {
        font-family: "Vazirmatn";
      }

      body {
        margin: 0;
        background-color: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      header {
        background-color: var(--primary);
        color: white;
        padding: 1rem;
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
        position: relative;
      }

      .settings-icon {
        position: absolute;
        left: 1rem;
        top: 1rem;
        cursor: pointer;
        font-size: 1.2rem;
      }

      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
      }

      .message {
        background-color: var(--surface);
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 12px;
        line-height: 1.8;
        white-space: pre-wrap;
      }

      .message.user {
        background-color: #4c1d95;
        text-align: right;
      }

      form {
        display: flex;
        padding: 1rem;
        background-color: var(--surface);
        gap: 0.5rem;
        border-top: 1px solid #334155;
      }

      input[type="text"] {
        flex: 1;
        padding: 0.75rem;
        font-size: 1rem;
        border-radius: 8px;
        border: none;
        outline: none;
        font-family: inherit;
        background: #1e293b;
        color: white;
      }

      button {
        padding: 0.75rem 1.25rem;
        font-size: 1rem;
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }

      pre {
        background: #0d1117;
        color: #c9d1d9;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        margin-top: 1rem;
        position: relative;
      }

      pre code {
        font-family: Consolas, Monaco, "Courier New", monospace;
      }

      .copy-btn {
        position: absolute;
        top: 8px;
        left: 8px;
        background: var(--accent);
        color: white;
        border: none;
        padding: 0.2rem 0.6rem;
        font-size: 0.75rem;
        border-radius: 6px;
        cursor: pointer;
      }

      .modal {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10;
      }

      .modal-content {
        background: var(--surface);
        padding: 2rem;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
      }

      .modal-content input {
        width: 100%;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <header>
      میو GPT

      <span class="settings-icon" onclick="toggleModal()">⚙️</span>
    </header>

    <div class="chat-container" id="chat"></div>

    <form id="promptForm">
      <input
        type="text"
        id="promptInput"
        placeholder="سوالت رو بنویس..."
        required
      />
      <button type="submit">ارسال</button>
    </form>

    <div class="modal" id="settingsModal">
      <div class="modal-content">
        <label>توکن Gemini API:</label>
        <input type="text" id="apiKeyInput" placeholder="API Key" />
        <button onclick="saveKey()">ذخیره</button>
        <a href="./prompt.html" target="_blank" rel="noopener noreferrer">پرامپت بوک</a>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      const chat = document.getElementById("chat");
      const form = document.getElementById("promptForm");
      const input = document.getElementById("promptInput");
      const modal = document.getElementById("settingsModal");
      const apiKeyInput = document.getElementById("apiKeyInput");

      // لود API Key
      const savedKey = localStorage.getItem("GEMINI_API_KEY");
      if (savedKey) apiKeyInput.value = savedKey;

      function toggleModal() {
        modal.style.display = modal.style.display === "flex" ? "none" : "flex";
      }

      function saveKey() {
        const key = apiKeyInput.value.trim();
        if (key) {
          localStorage.setItem("GEMINI_API_KEY", key);
          toggleModal();
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const prompt = input.value.trim();
        const apiKey = apiKeyInput.value.trim();

        if (!prompt || !apiKey) return alert("سوال و کلید الزامیست");

        addMessage(prompt, "user");
        input.value = "";
        input.disabled = true;

        try {
          const res = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text:
                          prompt +
                          "\n\nلطفاً پاسخ را با فرمت مارک‌داون کامل بده.",
                      },
                    ],
                  },
                ],
              }),
            }
          );

          const data = await res.json();
          const text =
            data?.candidates?.[0]?.content?.parts?.[0]?.text ||
            "❌ پاسخی دریافت نشد";
          renderBotMessage(text);
        } catch (err) {
          addMessage("❌ خطا در دریافت پاسخ", "bot");
        } finally {
          input.disabled = false;
          input.focus();
        }
      });

      function addMessage(text, sender) {
        const div = document.createElement("div");
        div.className = `message ${sender}`;
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      function renderBotMessage(markdown) {
        const div = document.createElement("div");
        div.className = "message bot";
        div.innerHTML = marked.parse(markdown);
        chat.appendChild(div);

        div.querySelectorAll("pre code").forEach((block) => {
          hljs.highlightElement(block);
          const btn = document.createElement("button");
          btn.textContent = "کپی";
          btn.className = "copy-btn";
          btn.onclick = () => {
            navigator.clipboard.writeText(block.textContent);
            btn.textContent = "✅";
            setTimeout(() => (btn.textContent = "کپی"), 1500);
          };
          block.parentElement.prepend(btn);
        });

        chat.scrollTop = chat.scrollHeight;
      }
    </script>
  </body>
</html>
